<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gesticulate - Minimal 3D Particles</title>
    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <!-- MediaPipe Hands -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <!-- GSAP for smooth transitions -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>

    <style>
        :root {
            --primary: #4e9aff;
            --glass: rgba(10, 10, 10, 0.7);
            --border: rgba(255, 255, 255, 0.1);
        }

        body {
            margin: 0;
            overflow: hidden;
            background-color: #030303;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            color: white;
            touch-action: none;
        }

        #container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        /* Minimal UI Components */
        .glass-panel {
            background: var(--glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 20px;
            pointer-events: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
            transition: all 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        /* Shape Panel - Top Right (Desktop), Collapsible Bottom (Mobile) */
        #shape-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 100;
            padding: 15px;
            width: 240px;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            cursor: pointer;
        }

        h1 {
            margin: 0;
            font-size: 0.85rem;
            font-weight: 700;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            color: var(--primary);
        }

        .controls-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            transition: opacity 0.3s ease;
        }

        button {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            color: #bbb;
            padding: 10px 5px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            transition: all 0.2s ease;
            -webkit-tap-highlight-color: transparent;
        }

        button.active {
            background: rgba(78, 154, 255, 0.4);
            border-color: var(--primary);
            color: white;
        }

        /* Tooltip Legend - Bottom Left */
        #legend-panel {
            position: absolute;
            bottom: 25px;
            left: 20px;
            z-index: 90;
            padding: 12px 18px;
            max-width: 280px;
            font-size: 0.75rem;
        }

        .legend-content {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 12px;
            color: #aaa;
        }

        .legend-icon {
            font-size: 1rem;
            width: 22px;
            text-align: center;
        }

        /* Status & Mobile Specific */
        #tracking-status {
            position: absolute;
            bottom: 25px;
            right: 20px;
            font-size: 0.65rem;
            font-weight: 700;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 30px;
            border: 1px solid var(--border);
            color: #ff4e4e;
        }

        .toggle-icon {
            font-size: 1.2rem;
            opacity: 0.6;
            transition: transform 0.3s ease;
        }

        /* Overlay */
        #start-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .start-btn {
            background: var(--primary);
            color: white;
            padding: 18px 45px;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 800;
            border: none;
            letter-spacing: 0.1em;
            box-shadow: 0 10px 30px rgba(78, 154, 255, 0.3);
            cursor: pointer;
        }

        /* Color Pill */
        .color-pill {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid var(--border);
        }

        input[type="color"] {
            -webkit-appearance: none;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: none;
            cursor: pointer;
        }

        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }

        input[type="color"]::-webkit-color-swatch {
            border-radius: 50%;
            border: 1px solid #fff;
        }

        /* MOBILE OPTIMIZATIONS */
        @media (max-width: 600px) {
            #shape-panel {
                top: auto;
                bottom: 20px;
                right: 15px;
                left: 15px;
                width: auto;
                padding: 12px;
            }

            #legend-panel {
                bottom: auto;
                top: 20px;
                left: 15px;
                right: 15px;
                max-width: none;
                padding: 10px 15px;
            }

            .collapsed .legend-content,
            .collapsed .controls-grid,
            .collapsed .color-pill {
                display: none;
            }

            .collapsed {
                padding: 10px 15px;
                border-radius: 30px;
            }

            .collapsed .panel-header {
                margin-bottom: 0;
            }

            .collapsed .toggle-icon {
                transform: rotate(-90deg);
            }

            #tracking-status {
                top: 75px;
                bottom: auto;
                right: 20px;
            }
        }
    </style>
</head>

<body>

    <div id="start-overlay">
        <button class="start-btn" onclick="startApp()">START EXPERIENCE</button>
        <p style="color: #666; font-size: 0.7rem; font-weight: 600; margin-top: 20px; letter-spacing: 0.2em;">HAND
            TRACKING 3D</p>
    </div>

    <div id="container"></div>

    <div id="legend-panel" class="glass-panel collapsed" onclick="togglePanel('legend-panel')">
        <div class="panel-header">
            <h1>Hand Guide</h1>
            <span class="toggle-icon">‚ñæ</span>
        </div>
        <div class="legend-content">
            <div class="legend-item"><span class="legend-icon">üñêÔ∏è</span> <span>Show hand to wake</span></div>
            <div class="legend-item"><span class="legend-icon">‚ÜïÔ∏è</span> <span>Move to translate</span></div>
            <div class="legend-item"><span class="legend-icon">üîÑ</span> <span>Tilt to rotate</span></div>
            <div class="legend-item"><span class="legend-icon">ü§è</span> <span>Open/Close to zoom</span></div>
        </div>
    </div>

    <div id="shape-panel" class="glass-panel collapsed" onclick="togglePanel('shape-panel')">
        <div class="panel-header">
            <h1>Transform</h1>
            <span class="toggle-icon">‚ñæ</span>
        </div>
        <div class="controls-grid">
            <button onclick="setShape('heart', event)" id="btn-heart">Heart</button>
            <button onclick="setShape('flower', event)" id="btn-flower">Flower</button>
            <button onclick="setShape('saturn', event)" id="btn-saturn">Saturn</button>
            <button onclick="setShape('buddha', event)" id="btn-buddha">Buddha</button>
            <button onclick="setShape('fireworks', event)" id="btn-fireworks">Fireworks</button>
            <button onclick="setShape('sphere', event)" id="btn-sphere" class="active">Sphere</button>
        </div>
        <div class="color-pill" onclick="event.stopPropagation()">
            <span style="font-size: 0.65rem; color: #888; font-weight: 700; letter-spacing: 0.1em;">TINT</span>
            <input type="color" id="colorPicker" value="#4e9aff">
        </div>
    </div>

    <div id="tracking-status">NO HAND</div>

    <video id="webcam" style="display:none;" autoplay playsinline></video>

    <script>
        let scene, camera, renderer, particleSystem, controls;
        const PARTICLE_COUNT = 6000;
        let currentShape = 'sphere';
        let handTension = 0.5, lerpedTension = 0.5;
        let handPos = { x: 0, y: 0 }, lerpedHandPos = { x: 0, y: 0 };
        let handRotation = 0, lerpedHandRotation = 0;
        let baseColor = new THREE.Color(0x4e9aff);

        function togglePanel(id) {
            document.getElementById(id).classList.toggle('collapsed');
        }

        function initThree() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 12;

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            document.getElementById('container').appendChild(renderer.domElement);

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.enableZoom = false;

            const geometry = new THREE.BufferGeometry();
            const positions = new Float32Array(PARTICLE_COUNT * 3);
            const colors = new Float32Array(PARTICLE_COUNT * 3);
            generateSphere(positions);

            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));

            const material = new THREE.PointsMaterial({
                size: 0.08, vertexColors: true, transparent: true,
                opacity: 0.9, blending: THREE.AdditiveBlending, depthWrite: false
            });

            particleSystem = new THREE.Points(geometry, material);
            scene.add(particleSystem);
            updateColors();

            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        function updateColors() {
            const colors = particleSystem.geometry.attributes.color.array;
            for (let i = 0; i < PARTICLE_COUNT; i++) {
                const c = new THREE.Color(baseColor).multiplyScalar(0.4 + Math.random() * 0.6);
                colors[i * 3] = c.r; colors[i * 3 + 1] = c.g; colors[i * 3 + 2] = c.b;
            }
            particleSystem.geometry.attributes.color.needsUpdate = true;
        }

        // Generators
        function generateSphere(arr, r = 4) {
            for (let i = 0; i < PARTICLE_COUNT; i++) {
                const phi = Math.acos(-1 + (2 * i) / PARTICLE_COUNT);
                const theta = Math.sqrt(PARTICLE_COUNT * Math.PI) * phi;
                arr[i * 3] = r * Math.cos(theta) * Math.sin(phi);
                arr[i * 3 + 1] = r * Math.sin(theta) * Math.sin(phi);
                arr[i * 3 + 2] = r * Math.cos(phi);
            }
        }

        function generateHeart(arr) {
            for (let i = 0; i < PARTICLE_COUNT; i++) {
                const t = Math.random() * Math.PI * 2;
                const x = 16 * Math.pow(Math.sin(t), 3);
                const y = 13 * Math.cos(t) - 5 * Math.cos(2 * t) - 2 * Math.cos(3 * t) - Math.cos(4 * t);
                arr[i * 3] = x * 0.25; arr[i * 3 + 1] = y * 0.25; arr[i * 3 + 2] = (Math.random() - 0.5) * 5;
            }
        }

        function generateFlower(arr) {
            for (let i = 0; i < PARTICLE_COUNT; i++) {
                const t = Math.random() * Math.PI * 2;
                const r = 4 * Math.cos(5 * t);
                const phi = Math.random() * Math.PI * 2;
                arr[i * 3] = r * Math.cos(t) * Math.cos(phi);
                arr[i * 3 + 1] = r * Math.sin(t) * Math.cos(phi);
                arr[i * 3 + 2] = r * Math.sin(phi) * 0.5;
            }
        }

        function generateSaturn(arr) {
            const ring = Math.floor(PARTICLE_COUNT * 0.4);
            for (let i = 0; i < PARTICLE_COUNT; i++) {
                if (i < ring) {
                    const phi = Math.acos(-1 + (2 * i) / ring), theta = Math.sqrt(ring * Math.PI) * phi;
                    arr[i * 3] = 2.5 * Math.cos(theta) * Math.sin(phi);
                    arr[i * 3 + 1] = 2.5 * Math.sin(theta) * Math.sin(phi);
                    arr[i * 3 + 2] = 2.5 * Math.cos(phi);
                } else {
                    const a = Math.random() * Math.PI * 2, d = 3.5 + Math.random() * 3;
                    arr[i * 3] = Math.cos(a) * d; arr[i * 3 + 1] = (Math.random() - 0.5) * 0.5; arr[i * 3 + 2] = Math.sin(a) * d;
                }
            }
        }

        function generateBuddha(arr) {
            for (let i = 0; i < PARTICLE_COUNT; i++) {
                const s = Math.random();
                if (s < 0.2) { // Head
                    const p = Math.random() * Math.PI * 2, t = Math.random() * Math.PI;
                    arr[i * 3] = 0.8 * Math.sin(t) * Math.cos(p); arr[i * 3 + 1] = 0.8 * Math.sin(t) * Math.sin(p) + 2.5; arr[i * 3 + 2] = 0.8 * Math.cos(t);
                } else if (s < 0.7) { // Body
                    const p = Math.random() * Math.PI * 2, t = Math.random() * Math.PI;
                    arr[i * 3] = 2.2 * Math.sin(t) * Math.cos(p); arr[i * 3 + 1] = 2.2 * Math.sin(t) * Math.sin(p); arr[i * 3 + 2] = 2.2 * Math.cos(t) * 0.8;
                } else { // Base
                    const a = Math.random() * Math.PI * 2, r = 3.5 * Math.sqrt(Math.random());
                    arr[i * 3] = r * Math.cos(a); arr[i * 3 + 1] = (Math.random() - 0.5) * 0.8 - 3; arr[i * 3 + 2] = r * Math.sin(a);
                }
            }
        }

        function generateFireworks(arr) {
            for (let i = 0; i < PARTICLE_COUNT; i++) {
                const t = Math.random() * Math.PI * 2, p = Math.random() * Math.PI, r = Math.pow(Math.random(), 0.1) * 8;
                arr[i * 3] = r * Math.sin(p) * Math.cos(t); arr[i * 3 + 1] = r * Math.sin(p) * Math.sin(t); arr[i * 3 + 2] = r * Math.cos(p);
            }
        }

        function setShape(shape) {
            currentShape = shape;
            document.querySelectorAll('button').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-' + shape).classList.add('active');
            const temp = new Float32Array(PARTICLE_COUNT * 3);
            if (shape === 'sphere') generateSphere(temp); else if (shape === 'heart') generateHeart(temp);
            else if (shape === 'flower') generateFlower(temp); else if (shape === 'saturn') generateSaturn(temp);
            else if (shape === 'buddha') generateBuddha(temp); else if (shape === 'fireworks') generateFireworks(temp);

            const posAttr = particleSystem.geometry.attributes.position;
            for (let i = 0; i < PARTICLE_COUNT; i++) {
                gsap.to(posAttr.array, {
                    duration: 1.5, ease: "power3.out",
                    [i * 3]: temp[i * 3], [i * 3 + 1]: temp[i * 3 + 1], [i * 3 + 2]: temp[i * 3 + 2],
                    onUpdate: () => { if (i === 0) posAttr.needsUpdate = true; }
                });
            }
        }

        // MediaPipe
        const hands = new Hands({ locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}` });
        hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
        hands.onResults(res => {
            const st = document.getElementById('tracking-status');
            if (res.multiHandLandmarks && res.multiHandLandmarks.length > 0) {
                st.innerText = "TRACKING"; st.style.color = "#4e9aff";
                const lm = res.multiHandLandmarks[0];
                handPos.x = -(lm[0].x - 0.5) * 30; handPos.y = -(lm[0].y - 0.5) * 20;
                let d = 0;[4, 8, 12, 16, 20].forEach(i => {
                    d += Math.sqrt(Math.pow(lm[i].x - lm[0].x, 2) + Math.pow(lm[i].y - lm[0].y, 2));
                });
                handTension = Math.max(0.1, Math.min(2, (d / 5 - 0.1) / 0.4));
                handRotation = Math.atan2(lm[9].y - lm[0].y, lm[9].x - lm[0].x) + Math.PI / 2;
            } else {
                st.innerText = "NO HAND"; st.style.color = "#ff4e4e";
                handPos = { x: 0, y: 0 }; handTension = 0.5; handRotation = 0;
            }
        });

        async function startApp() {
            document.getElementById('start-overlay').style.display = 'none';
            initThree(); requestAnimationFrame(animate);
            const cam = new Camera(document.getElementById('webcam'), {
                onFrame: async () => { await hands.send({ image: document.getElementById('webcam') }); },
                width: 640, height: 480, facingMode: 'user'
            });
            cam.start();
        }

        function animate() {
            requestAnimationFrame(animate);
            lerpedTension += (handTension - lerpedTension) * 0.1;
            lerpedHandPos.x += (handPos.x - lerpedHandPos.x) * 0.1;
            lerpedHandPos.y += (handPos.y - lerpedHandPos.y) * 0.1;
            lerpedHandRotation += (handRotation - lerpedHandRotation) * 0.1;
            if (particleSystem) {
                particleSystem.scale.setScalar(0.5 + lerpedTension * 2.5);
                particleSystem.position.set(lerpedHandPos.x, lerpedHandPos.y, 0);
                particleSystem.rotation.z = lerpedHandRotation;
                particleSystem.rotation.y += 0.005;
            }
            controls.update(); renderer.render(scene, camera);
        }

        document.getElementById('colorPicker').addEventListener('input', e => {
            baseColor.set(e.target.value); updateColors();
        });
    </script>
</body>

</html>